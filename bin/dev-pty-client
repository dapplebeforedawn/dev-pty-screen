#! /usr/bin/env ruby

require 'socket'
require 'io/console'

require_relative '../lib/client/app'

Thread.abort_on_exception = true

class DevPtyClient
  READSIZE = 4096
  CLEAR    = "\e[H\e[2J"
  SUSPEND  = ?\C-z


  def initialize
    startup_message

    @key_sock    = Socket.tcp(App.options.server_host,    App.options.key_port)
    @screen_sock = Socket.tcp(App.options.server_host, App.options.screen_port)

    Thread.new &screen_loop
    Thread.new &key_loop
  end

  def screen_loop
    -> do
      loop { STDOUT.write @screen_sock.readpartial( READSIZE ) }
    end
  end

  def key_loop
    -> do
      loop {
        key = STDIN.getch
        prompt_exit if suspend?(key)
        @key_sock.write key
      }
    end
  end

  def suspend?(key)
    key == SUSPEND
  end

  def prompt_exit
    clear_screen
    print "Disconnect from dev-pty-screen?(y/n): "
    exit if gets.match /y/i
  end

  def clear_screen
    puts CLEAR
  end

  def startup_message
    clear_screen
    message_lines = File.readlines App.path.parent.join('doc', 'welcome.txt')
    longest_line  = message_lines.max_by(&:length).length
    screen_width  = STDOUT.winsize.last
    offset        = Array.new(screen_width/2 - longest_line/2, " ")
    message_lines.each do |line|
      print  offset * '' + line
    end
  end
end

at_exit { `reset` }
DevPtyClient.new and sleep
